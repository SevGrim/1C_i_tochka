## Пример анализа и исправления

Исходный код (когнитивная сложность: 26, цикломатическая сложность: 12)

```
Функция ПолучитьСтоимость(ВходныеПараметры) Экспорт
	Стоимость = 0;
	Если ВходныеПараметры.ФормироватьПоЗапасам Тогда
		Выборка = ВыполнитьЗапросПолученияСтоимостиПоЗапасам.Выбрать();
				
		ВалютаУчета = ОбщегоНазначения.ЗначениеКонстанты("ВалютаУчета");
		Если НЕ ЗначениеЗаполнено(ВходныеПараметры.Валюта) Тогда
			ВходныеПараметры.Валюта = ВалютаУчета;
		КонецЕсли; 
		
		Если Выборка.Следующий() Тогда
			
			Если ЗначениеЗаполнено(Выборка.Количество) Тогда
				Если ВходныеПараметры.ЗначениеОтображатьСебестоимостьСНДС Тогда
					Если ВалютаУчета = ВходныеПараметры.Валюта Тогда
						Стоимость = Выборка.Сумма/Выборка.Количество;
					Иначе
						Стоимость = РаботаСКурсамиВалют.ПересчитатьВВалюту(Выборка.Сумма/Выборка.Количество, ВалютаУчета, 
							ВходныеПараметры.Валюта, ВходныеПараметры.Дата);
					КонецЕсли;	
				Иначе
					Если ВалютаУчета = ВходныеПараметрыВалюта Тогда
						Стоимость = (Выборка.Сумма - Выборка.СуммаНДС)/Выборка.Количество;
					Иначе
						Стоимость = РаботаСКурсамиВафлют.ПересчитатьВВалюту((Выборка.Сумма - Выборка.СуммаНДС)/Выборка.Количество, 
						ВалютаУчета, ВходныеПараметры.Валюта, ВходныеПараметры.Дата);
					КонецЕсли;	
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;

	Если Стоимость = 0 Тогда
		СтруктураДанные = ПодготовитьСтруктуруДляРасчетаЦен(ВходныеПараметры);

		Стоимость = ЦенообразованиеСервер.ПолучитьЦенуНоменклатурыПоВидуЦен(СтруктураДанные);		
	КонецЕсли;
	
	Возврат Стоимость;
КонецФункции

```

### Итерация 1. Декомпозиция по функциональным блокам

На первом этапе можно попробовать разбить на функциональные блоки. 

Вынесем математику получения стоимости по запасам в отдельную функцию. Теперь когнитивная сложность функции ПолучитьСтоимость составляет 2, а цикломатическая - 3. При этом взглянув на нее можно быстро осознать алгоритм: если настройка ФормироватьПоЗапасам включена, то идет попытка получение стоимости по запасам, иначе сразу по виду цен. 

```
Функция ПолучитьСтоимость(ВходныеПараметры) Экспорт
	Стоимость = 0;
	Если ВходныеПараметры.ФормироватьПоЗапасам Тогда
		Стоимость = ПолучитьСтоимостьПоЗапасам(ВходныеПараметры);
	КонецЕсли;

	Если Стоимость = 0 Тогда
		СтруктураДанные = ПодготовитьСтруктуруДляРасчетаЦен(ВходныеПараметры);
		Стоимость = ЦенообразованиеСервер.ПолучитьЦенуНоменклатурыПоВидуЦен(СтруктураДанные);		
	КонецЕсли;
	
	Возврат Стоимость;
КонецФункции

Функция ПолучитьСтоимостьПоЗапасам(ВходныеПараметры)
	Стоимость = 0;

	Выборка = ВыполнитьЗапросПолученияСтоимостиПоЗапасам.Выбрать();		
	ВалютаУчета = ОбщегоНазначения.ЗначениеКонстанты("ВалютаУчета");
	Если НЕ ЗначениеЗаполнено(ВходныеПараметры.Валюта) Тогда
		ВходныеПараметры.Валюта = ВалютаУчета;
	КонецЕсли; 
	Если Выборка.Следующий() Тогда
		
		Если ЗначениеЗаполнено(Выборка.Количество) Тогда
			Если ВходныеПараметры.ЗначениеОтображатьСебестоимостьСНДС Тогда
				Если ВалютаУчета = ВходныеПараметры.Валюта Тогда
					Стоимость = Выборка.Сумма/Выборка.Количество;
				Иначе
					Стоимость = РаботаСКурсамиВалют.ПересчитатьВВалюту(Выборка.Сумма/Выборка.Количество, ВалютаУчета, 
						ВходныеПараметры.Валюта, ВходныеПараметры.Дата);
				КонецЕсли;	
			Иначе
				Если ВалютаУчета = ВходныеПараметрыВалюта Тогда
					Стоимость = (Выборка.Сумма - Выборка.СуммаНДС)/Выборка.Количество;
				Иначе
					Стоимость = РаботаСКурсамиВафлют.ПересчитатьВВалюту((Выборка.Сумма - Выборка.СуммаНДС)/Выборка.Количество, 
					ВалютаУчета, ВходныеПараметры.Валюта, ВходныеПараметры.Дата);
				КонецЕсли;	
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;

	Возврат Стоимость;
КонецФункции
```

### Итерация 2. Убираем лишнюю вложенность

Перейдем к анализу функции ПолучитьСтоимостьПоЗапасам (когнитивная сложность 18, цикломатическая - 10). 

Если начало функции нас ни как не смущает, то вот обход выборки - весьма.

На строке 25 осуществляется проверка в цикле, которая не имеет альтернативных веток и математики после условия. Получается, что всем операторам внутри условия всегда добавляется лишняя единица. 

Инвертируем значение условия, а вложенную математику вынесем после условия:

```
Функция ПолучитьСтоимость(ВходныеПараметры) Экспорт
	Стоимость = 0;
	Если ВходныеПараметры.ФормироватьПоЗапасам Тогда
		Стоимость = ПолучитьСтоимостьПоЗапасам(ВходныеПараметры);
	КонецЕсли;

	Если Стоимость = 0 Тогда
		СтруктураДанные = ПодготовитьСтруктуруДляРасчетаЦен(ВходныеПараметры);
		Стоимость = ЦенообразованиеСервер.ПолучитьЦенуНоменклатурыПоВидуЦен(СтруктураДанные);		
	КонецЕсли;
	
	Возврат Стоимость;
КонецФункции

Функция ПолучитьСтоимостьПоЗапасам(ВходныеПараметры)
	Стоимость = 0;

	Выборка = ВыполнитьЗапросПолученияСтоимостиПоЗапасам.Выбрать();		
	ВалютаУчета = ОбщегоНазначения.ЗначениеКонстанты("ВалютаУчета");
	Если НЕ ЗначениеЗаполнено(ВходныеПараметры.Валюта) Тогда
		ВходныеПараметры.Валюта = ВалютаУчета;
	КонецЕсли; 
	Если Выборка.Следующий() Тогда
		
		Если НЕ ЗначениеЗаполнено(Выборка.Количество) Тогда
			Продолжить;
		КонецЕсли;
        Если ВходныеПараметры.ЗначениеОтображатьСебестоимостьСНДС Тогда
				Если ВалютаУчета = ВходныеПараметры.Валюта Тогда
					Стоимость = Выборка.Сумма/Выборка.Количество;
				Иначе
					Стоимость = РаботаСКурсамиВалют.ПересчитатьВВалюту(Выборка.Сумма/Выборка.Количество, ВалютаУчета, 
						ВходныеПараметры.Валюта, ВходныеПараметры.Дата);
				КонецЕсли;	
			Иначе
				Если ВалютаУчета = ВходныеПараметрыВалюта Тогда
					Стоимость = (Выборка.Сумма - Выборка.СуммаНДС)/Выборка.Количество;
				Иначе
					Стоимость = РаботаСКурсамиВафлют.ПересчитатьВВалюту((Выборка.Сумма - Выборка.СуммаНДС)/Выборка.Количество, 
					ВалютаУчета, ВходныеПараметры.Валюта, ВходныеПараметры.Дата);
				КонецЕсли;	
			КонецЕсли;
	КонецЕсли;

	Возврат Стоимость;
КонецФункции
```


### Итерация 3. Убираем повторяющиеся участки кода

Вроде простое действие, а когнитивная сложность упала на 3 значения и стала 15. Данное значение уже является допустимым, но выжмем из данной функции еще немного. Например, строки 30-35 и 37-42 отличаются лишь вычитанием сумму НДС.

Давайте инициализируем сумму НДС по условию, а остальную математику вычислим в конце:

```
Функция ПолучитьСтоимостьПоЗапасам(ВходныеПараметры)
	Стоимость = 0;
	
	Выборка = ВыполнитьЗапросПолученияСтоимостиПоЗапасам.Выбрать();
	ВалютаУчета = ОбщегоНазначения.ЗначениеКонстанты("ВалютаУчета");
	Если НЕ ЗначениеЗаполнено(ВходныеПараметры.Валюта) Тогда
		ВходныеПараметры.Валюта = ВалютаУчета;
	КонецЕсли;
	
	Если Выборка.Следующий() Тогда
		
		Если НЕ ЗначениеЗаполнено(Выборка.Количество) Тогда
			Продолжить;
		КонецЕсли;	
		
		СуммаНДС = 0;
		Если НЕ ВходныеПараметры.ЗначениеОтображатьСебестоимостьСНДС Тогда
			СуммаНДС = Выборка.СуммаНДС;
		КонецЕсли;

		Если ВалютаУчета = ВходныеПараметрыВалюта Тогда
			Стоимость = (Выборка.Сумма - СуммаНДС) / Выборка.Количество;
		Иначе
			Стоимость = РаботаСКурсамиВафлют.ПересчитатьВВалюту((Выборка.Сумма - СуммаНДС) / Выборка.Количество,
					ВалютаУчета, ВходныеПараметры.Валюта, ВходныеПараметры.Дата);
		КонецЕсли;

	КонецЕсли;
		
	Возврат Стоимость;
КонецФункции
```
В результате когнитивная сложность опустилась до 9, а цикломатическая до 7. На этом основную оптимизацию будем считать завершенной.

