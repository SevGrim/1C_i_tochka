## Рассматриваемый пример

```
Функция ПолучитьСтоимость(ВходныеПараметры) Экспорт
	Стоимость = 0;
	Если ВходныеПараметры.ФормироватьПоЗапасам Тогда
		Выборка = ВыполнитьЗапросПолученияСтоимостиПоЗапасам.Выбрать();
				
		ВалютаУчета = ОбщегоНазначения.ЗначениеКонстанты("ВалютаУчета");
		Если НЕ ЗначениеЗаполнено(ВходныеПараметры.Валюта) Тогда
			ВходныеПараметры.Валюта = ВалютаУчета;
		КонецЕсли; 
		
		Если Выборка.Следующий() Тогда
			
			Если ЗначениеЗаполнено(Выборка.Количество) Тогда
				Если ВходныеПараметры.ЗначениеОтображатьСебестоимостьСНДС Тогда
					Если ВалютаУчета = ВходныеПараметры.Валюта Тогда
						Стоимость = Выборка.Сумма/Выборка.Количество;
					Иначе
						Стоимость = РаботаСКурсамиВалют.ПересчитатьВВалюту(Выборка.Сумма/Выборка.Количество, ВалютаУчета, 
							ВходныеПараметры.Валюта, ВходныеПараметры.Дата);
					КонецЕсли;	
				Иначе
					Если ВалютаУчета = ВходныеПараметрыВалюта Тогда
						Стоимость = (Выборка.Сумма - Выборка.СуммаНДС)/Выборка.Количество;
					Иначе
						Стоимость = РаботаСКурсамиВафлют.ПересчитатьВВалюту((Выборка.Сумма - Выборка.СуммаНДС)/Выборка.Количество, 
						ВалютаУчета, ВходныеПараметры.Валюта, ВходныеПараметры.Дата);
					КонецЕсли;	
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;

	Если Стоимость = 0 Тогда
		СтруктураДанные = ПодготовитьСтруктуруДляРасчетаЦен(ВходныеПараметры);

		Стоимость = ЦенообразованиеСервер.ПолучитьЦенуНоменклатурыПоВидуЦен(СтруктураДанные);		
	КонецЕсли;
	
	Возврат Стоимость;
КонецФункции

```

### Итерация 1. Декомпозиция по функциональным блокам

```
Функция ПолучитьСтоимость(ВходныеПараметры) Экспорт
	Стоимость = 0;
	Если ВходныеПараметры.ФормироватьПоЗапасам Тогда
		Стоимость = ПолучитьСтоимостьПоЗапасам(ВходныеПараметры);
	КонецЕсли;

	Если Стоимость = 0 Тогда
		СтруктураДанные = ПодготовитьСтруктуруДляРасчетаЦен(ВходныеПараметры);
		Стоимость = ЦенообразованиеСервер.ПолучитьЦенуНоменклатурыПоВидуЦен(СтруктураДанные);		
	КонецЕсли;
	
	Возврат Стоимость;
КонецФункции

Функция ПолучитьСтоимостьПоЗапасам(ВходныеПараметры)
	Стоимость = 0;

	Выборка = ВыполнитьЗапросПолученияСтоимостиПоЗапасам.Выбрать();		
	ВалютаУчета = ОбщегоНазначения.ЗначениеКонстанты("ВалютаУчета");
	Если НЕ ЗначениеЗаполнено(ВходныеПараметры.Валюта) Тогда
		ВходныеПараметры.Валюта = ВалютаУчета;
	КонецЕсли; 
	Если Выборка.Следующий() Тогда
		
		Если ЗначениеЗаполнено(Выборка.Количество) Тогда
			Если ВходныеПараметры.ЗначениеОтображатьСебестоимостьСНДС Тогда
				Если ВалютаУчета = ВходныеПараметры.Валюта Тогда
					Стоимость = Выборка.Сумма/Выборка.Количество;
				Иначе
					Стоимость = РаботаСКурсамиВалют.ПересчитатьВВалюту(Выборка.Сумма/Выборка.Количество, ВалютаУчета, 
						ВходныеПараметры.Валюта, ВходныеПараметры.Дата);
				КонецЕсли;	
			Иначе
				Если ВалютаУчета = ВходныеПараметрыВалюта Тогда
					Стоимость = (Выборка.Сумма - Выборка.СуммаНДС)/Выборка.Количество;
				Иначе
					Стоимость = РаботаСКурсамиВафлют.ПересчитатьВВалюту((Выборка.Сумма - Выборка.СуммаНДС)/Выборка.Количество, 
					ВалютаУчета, ВходныеПараметры.Валюта, ВходныеПараметры.Дата);
				КонецЕсли;	
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;

	Возврат Стоимость;
КонецФункции
```

### Итерация 2. Убираем лишнюю вложенность

```
Функция ПолучитьСтоимость(ВходныеПараметры) Экспорт
	Стоимость = 0;
	Если ВходныеПараметры.ФормироватьПоЗапасам Тогда
		Стоимость = ПолучитьСтоимостьПоЗапасам(ВходныеПараметры);
	КонецЕсли;

	Если Стоимость = 0 Тогда
		СтруктураДанные = ПодготовитьСтруктуруДляРасчетаЦен(ВходныеПараметры);
		Стоимость = ЦенообразованиеСервер.ПолучитьЦенуНоменклатурыПоВидуЦен(СтруктураДанные);		
	КонецЕсли;
	
	Возврат Стоимость;
КонецФункции

Функция ПолучитьСтоимостьПоЗапасам(ВходныеПараметры)
	Стоимость = 0;

	Выборка = ВыполнитьЗапросПолученияСтоимостиПоЗапасам.Выбрать();		
	ВалютаУчета = ОбщегоНазначения.ЗначениеКонстанты("ВалютаУчета");
	Если НЕ ЗначениеЗаполнено(ВходныеПараметры.Валюта) Тогда
		ВходныеПараметры.Валюта = ВалютаУчета;
	КонецЕсли; 
	Если Выборка.Следующий() Тогда
		
		Если НЕ ЗначениеЗаполнено(Выборка.Количество) Тогда
			Продолжить;
		КонецЕсли;
        Если ВходныеПараметры.ЗначениеОтображатьСебестоимостьСНДС Тогда
				Если ВалютаУчета = ВходныеПараметры.Валюта Тогда
					Стоимость = Выборка.Сумма/Выборка.Количество;
				Иначе
					Стоимость = РаботаСКурсамиВалют.ПересчитатьВВалюту(Выборка.Сумма/Выборка.Количество, ВалютаУчета, 
						ВходныеПараметры.Валюта, ВходныеПараметры.Дата);
				КонецЕсли;	
			Иначе
				Если ВалютаУчета = ВходныеПараметрыВалюта Тогда
					Стоимость = (Выборка.Сумма - Выборка.СуммаНДС)/Выборка.Количество;
				Иначе
					Стоимость = РаботаСКурсамиВафлют.ПересчитатьВВалюту((Выборка.Сумма - Выборка.СуммаНДС)/Выборка.Количество, 
					ВалютаУчета, ВходныеПараметры.Валюта, ВходныеПараметры.Дата);
				КонецЕсли;	
			КонецЕсли;
	КонецЕсли;

	Возврат Стоимость;
КонецФункции
```


### Итерация 3. Убираем повторяющиеся участки кода
```
Функция ПолучитьСтоимостьПоЗапасам(ВходныеПараметры)
	Стоимость = 0;
	
	Выборка = ВыполнитьЗапросПолученияСтоимостиПоЗапасам.Выбрать();
	ВалютаУчета = ОбщегоНазначения.ЗначениеКонстанты("ВалютаУчета");
	Если НЕ ЗначениеЗаполнено(ВходныеПараметры.Валюта) Тогда
		ВходныеПараметры.Валюта = ВалютаУчета;
	КонецЕсли;
	
	Если Выборка.Следующий() Тогда
		
		Если НЕ ЗначениеЗаполнено(Выборка.Количество) Тогда
			Продолжить;
		КонецЕсли;	
		
		СуммаНДС = 0;
		Если НЕ ВходныеПараметры.ЗначениеОтображатьСебестоимостьСНДС Тогда
			СуммаНДС = Выборка.СуммаНДС;
		КонецЕсли;

		Если ВалютаУчета = ВходныеПараметрыВалюта Тогда
			Стоимость = (Выборка.Сумма - СуммаНДС) / Выборка.Количество;
		Иначе
			Стоимость = РаботаСКурсамиВафлют.ПересчитатьВВалюту((Выборка.Сумма - СуммаНДС) / Выборка.Количество,
					ВалютаУчета, ВходныеПараметры.Валюта, ВходныеПараметры.Дата);
		КонецЕсли;

	КонецЕсли;
		
	Возврат Стоимость;
КонецФункции
```